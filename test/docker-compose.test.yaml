
x-test-host-template: &test_host_template
  image: busybox:latest
  volumes: 
    - ./test-server.sh:/test-server.sh:ro
  command: /test-server.sh

services:
  test_host_1:
    <<: *test_host_template
    networks:
        test-net:
          aliases:
          - host.ex

  test_host_2:
    <<: *test_host_template
    networks:
        test-net:
          aliases:
          - host.test.ex

  redis:
    image: redis:7
    command: ["redis-server", "--databases", "2"]
    networks:
        redis-net:
          aliases:
          - redis.gateway
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 2s
      retries: 3

  gateway:
    image: gateway
    container_name: gateway
    ports:
      - "8080:8080" 
    volumes:
      - ./test-config.yaml:/usr/etc/gateway/config.yaml:ro
    command: gateway --config=/usr/etc/gateway/config.yaml
    environment:
      HOST: "0.0.0.0"
      PORT: 8080
      READ_TIMEOUT: 10s
      WRITE_TIMEOUT: 10s
      EDGE_LIMITER_REDIS_URL: "redis://redis.gateway:6379/0"
      PROXY_LIMITER_REDIS_URL: "redis://redis.gateway:6379/1"
    depends_on:
      - redis
    networks:
      - global-net
      - redis-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 2s
      retries: 3

  test-client:
    image: busybox:latest
    volumes: 
      - ./test-entrypoint.sh:/test-entrypoint.sh:ro
    command: /test-entrypoint.sh

networks:
  redis-net:
    driver: bridge

  test-net:
    driver: bridge

  global-net:
